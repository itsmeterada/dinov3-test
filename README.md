# DINOv3画像検索ツール

**日本語 | [English](README_en.md)**

![Screenshot](screenshot.png)

DINOv3（Vision Transformer）を使用した画像検索アプリケーションです。PyQt6でGUIを提供し、画像の特徴量を使った類似画像検索が可能です。

## 特徴

- **DINOv3モデル**: Facebookの最新自己教師あり学習モデルを使用
- **画像検索**: 画像から類似画像を検索
- **データベース管理**: SQLiteで特徴量を永続化
- **フォルダ/ZIP処理**: 画像の一括登録
- **美しいGUI**: PyQt6でモダンなUI
- **ドラッグ&ドロップ**: 簡単な操作性

## インストール

### 必要な環境
- Python 3.8以上
- CUDA対応GPU（推奨、CPUでも動作）

### 依存関係のインストール

```bash
pip install -r requirements_dinov3.txt
```

## 使い方

### 1. アプリケーションの起動

```bash
python dinov3_search.py
```

初回起動時にDINOv3モデルが自動的にダウンロードされます。

### 2. 画像の追加

#### 方法1: ドラッグ&ドロップ
- 画像ファイルを画像表示エリアにドラッグ&ドロップ

#### 方法2: ボタンから選択
- 「画像を選択」ボタンをクリック
- 「フォルダを選択」ボタンで一括登録
- 「ZIPを選択」ボタンでZIP内の画像を一括登録

### 3. モデル選択

- GUI上部のドロップダウンメニューから使用するDINOv3モデルを選択
- モデル変更時は確認ダイアログが表示されます
- 各データベースには使用したモデル情報が記録されます
- データベース名の横に使用モデルが表示されます（例: `[ViT-B/16 (86M)]`）

### 4. 画像検索

1. 画像をドロップまたは選択
2. 自動的に類似画像が検索され、右側に表示されます
3. 類似度（0-100%）で色分け表示

### 5. データベース管理

- **新規作成**: 新しいデータベースを作成
- **DB消去**: 現在のデータベースの内容を消去
- **DB削除**: データベースファイルを完全に削除
- **更新**: データベースリストを更新
- **モデル情報**: 各データベースに使用モデルが自動記録され、不一致時に警告

## 主な機能

### 画像検索
- 画像から類似画像を検索
- コサイン類似度でランキング表示
- トップ10の類似画像を表示

### データベース
- SQLiteで特徴量を保存
- 重複チェック（MD5ハッシュ）
- サムネイル自動生成
- モデル情報の自動記録と管理
- モデル不一致時の警告機能

### バッチ処理
- フォルダ内の画像を一括登録
- ZIPファイル内の画像を一括登録
- 進捗表示

## 技術仕様

### DINOv3モデル
- デフォルトモデル: `facebook/dinov3-vitb16-pretrain-lvd1689m`
- 入力サイズ: 224x224
- 特徴量: 768次元（pooler_output）
- ライブラリ: Hugging Face Transformers

#### 利用可能なモデル

**Vision Transformer (ViT) モデル - LVD-1689Mデータセット:**
- **ViT-S/16 (21M)**: 最小・高速モデル。メモリ使用量が少なく、CPUでも実行可能
- **ViT-S+/16 (29M)**: ViT-Sの改良版。精度が若干向上
- **ViT-B/16 (86M)**: バランス型。精度と速度のバランスが良い（デフォルト）
- **ViT-L/16 (300M)**: 大型モデル。高精度だがGPU推奨
- **ViT-H+/16 (840M)**: 超大型モデル。最高精度だが大容量GPU必須
- **ViT-7B/16 (6.7B)**: 最大モデル。研究用途向け、非常に大容量のGPU必須

**ConvNeXt モデル - LVD-1689Mデータセット:**
- **ConvNeXt Tiny (29M)**: 畳み込みベースの軽量モデル
- **ConvNeXt Small (50M)**: 標準的なConvNeXtモデル
- **ConvNeXt Base (89M)**: バランス型ConvNeXt
- **ConvNeXt Large (198M)**: 大型ConvNeXt。GPU推奨

**衛星画像特化モデル - SAT-493Mデータセット:**
- **ViT-L/16 SAT (300M)**: 衛星画像・リモートセンシング用途に最適化
- **ViT-7B/16 SAT (6.7B)**: 衛星画像用の最大モデル

**モデル選択のガイドライン:**
- **CPU環境**: ViT-S/16, ViT-S+/16
- **GPU環境（8GB未満）**: ViT-B/16, ConvNeXt Tiny/Small
- **GPU環境（8GB以上）**: ViT-L/16, ConvNeXt Base/Large
- **高性能GPU（24GB以上）**: ViT-H+/16
- **衛星画像・航空写真**: ViT-L/16 SAT

### データベーススキーマ

#### imagesテーブル
- id: 画像ID（主キー）
- file_path: ファイルパス
- file_hash: MD5ハッシュ
- thumbnail: サムネイル画像（BLOB）

#### featuresテーブル
- image_id: 画像ID（外部キー）
- feature_vector: 特徴量ベクトル（BLOB）

#### model_infoテーブル
- id: 固定値1（主キー）
- model_name: 使用モデルのID（例: `facebook/dinov3-vitb16-pretrain-lvd1689m`）
- created_at: 作成日時
- updated_at: 更新日時

## CLIPとの違い

### DINOv3の特徴
- ✅ 画像のみの特徴抽出に特化
- ✅ 自己教師あり学習で訓練
- ✅ 高品質な画像特徴量
- ❌ テキスト検索は非対応

### CLIPの特徴
- ✅ 画像とテキストの両方に対応
- ✅ テキストから画像検索が可能
- ✅ マルチモーダル学習

## トラブルシューティング

### モデルのダウンロードに失敗する
- インターネット接続を確認
- Hugging Faceへのアクセスを確認

### 特徴量抽出が遅い
- GPUが利用可能か確認
- CUDAが正しくインストールされているか確認

### メモリ不足エラー
- 画像サイズを小さくする
- バッチ処理の際は少量ずつ処理
- より小さなモデル（ViT-S/16など）を使用

### モデル不一致の警告が表示される
- データベースは特定のモデルで作成された特徴量を保存しています
- 異なるモデルの特徴量は互換性がありません
- 解決方法：
  - 新しいデータベースを作成して画像を再登録
  - または、データベース作成時と同じモデルを選択

## ライセンス

このプロジェクトはMITライセンスの下で公開されています。

## 参考

- [DINOv3 Paper](https://arxiv.org/abs/2304.07193)
- [Hugging Face - DINOv3](https://huggingface.co/facebook/dinov3-vitb16-pretrain-lvd1689m)
